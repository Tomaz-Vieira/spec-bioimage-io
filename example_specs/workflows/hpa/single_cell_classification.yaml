name: HPA Single-cell Classification Example Workflow
description: A workflow for running HPA single-cell classification
format_version: 0.2.3
type: workflow

inputs_spec:
- name: nuclei
  type: tensor
  axes:
  - type: batch
  - name: gray scale
    type: channel
  - name: x
    type: space
  - name: y
    type: space
- name: protein
  type: tensor
  axes:
  - type: batch
  - name: gray scale
    type: channel
  - name: x
    type: space
  - name: y
    type: space

options_spec:
- name: seg_prep
  type: boolean
  default: false


outputs_spec:
- name: cells
  type: tensor
  axes:
  - type: batch
  - name: gray scale
    type: channel
  - name: x
    type: space
  - name: y
    type: space
- name: scores
  type: tensor
  axes:
  - type: batch
  - name: gray scale
    type: channel
  - name: x
    type: space
  - name: y
    type: space

steps:
- id: segmentation
  op: model_inference
  inputs: [inputs.nuclei]  # take the first output of step 1 (id: data) as the only input
  options:
    rdf_source: conscientious-seashell
    preprocessing: ${{ self.options.seg_prep }}
    postprocessing: false
  outputs: [cells]
- id: classification
  op: model_inference
  inputs: [inputs.protein, segmentation.outputs.cells]  # take the second output of step1 and the output of step 2
  options:
    rdf_source: straightforward-crocodile
    preprocessing: true
    postprocessing: false
  outputs: [scores]
- op: select_outputs
  inputs: [segmentation.outputs.cells,  classification.outputs.scores]

test_steps:
- op: load_tensors
  id: test_tensors
  options:
    sources: [nuclei.npy, protein.npy, cells.npy, scores.npy]
  outputs: [nuclei, protein, cells, scores]
- op: run_workflow
  id: workflow
  inputs: [test_tensors.outputs.nuclei, test_tensors.outputs.protein]
  options:
    rdf_source: ${{ self.rdf_source }}
  outputs: [cells, scores]
- op: assert_close
  inputs: [test_tensors.outputs.cells, workflow.outputs.cells]
- op: assert_close
  inputs: [test_tensors.outputs.scores, workflow.outputs.scores]
