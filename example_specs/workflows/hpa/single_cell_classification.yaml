name: HPA Single-cell Classification Example Workflow
description: A workflow for running HPA single-cell classification
format_version: 0.2.3
type: workflow

inputs:
- name: nuclei
  type: tensor
- name: protein
  type: tensor

kwargs:
- name: seg_prep
  type: boolean
  default: false


outputs:
- name: cells
  type: tensor
- name: scores
  type: tensor


steps:
- op: set_
- id: segmentation
  op: model_inference
  inputs: [inputs.nuclei]  # take the first output of step 1 (id: data) as the only input
  outputs: [cells]
  kwargs:
    rdf_source: conscientious-seashell
    preprocessing: ${{ kwargs.seg_prep }}
    postprocessing: false
- id: classification
  op: model_inference
  inputs: [inputs.protein, segmentation.outputs.cells]  # take the second output of step1 and the output of step 2
  outputs: [scores]
  kwargs:
    rdf_source: straightforward-crocodile
    preprocessing: true
    postprocessing: false
- op: select_outputs
  inputs: [segmentation.outputs.cells,  classification.outputs.scores]

test_steps:
- id: test_tensors
  op: load_tensors
  outputs: [nuclei, protein, cells, scores]
  kwargs:
    sources: [nuclei.npy, protein.npy, cells.npy, scores.npy]
- id: workflow
  op: run_workflow
  inputs: [test_tensors.outputs.nuclei, test_tensors.outputs.protein]
  outputs: [cells, scores]
  kwargs:
    rdf_source: ${{ self.rdf_source }}
- op: assert_close
  inputs: [test_tensors.outputs.cells, workflow.outputs.cells]
- op: assert_close
  inputs: [test_tensors.outputs.scores, workflow.outputs.scores]
