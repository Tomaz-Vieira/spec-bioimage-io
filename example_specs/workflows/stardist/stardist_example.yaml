name: StarDist Example Workflow
description: A workflow for running stardist
format_version: 0.2.3
type: workflow

inputs:
- name: raw
  type: tensor
  description: image with star-convex objects
  axes:
  - type: batch
  - name: gray scale
    type: channel
  - name: x
    type: space
  - name: y
    type: space

options:
- name: diameter
  type: float
  default: 2.3

outputs:
- name: labels
  type: tensor
  axes:
  - type: batch
  - name: label id
    type: channel
  - name: x
    type: space
  - name: y
    type: space
- name: coord
  type: list
- name: points
  type: list
- name: prob
  type: tensor
  axes:
  - type: batch
  - name: probability
    type: channel
  - name: x
    type: space
  - name: y
    type: space

steps:
- op: zero_mean_unit_variance
- op: model_inference
  options:
    rdf_source: fearless-crab
    preprocessing: false # disable the preprocessing
    postprocessing: false # disable the postprocessing
- op: stardist_postprocessing
  options:
    diameter: "${{ self.options.diameter }}"

test_steps:
- id: test_tensors
  op: load_tensors
  options:
    sources:
    - raw.npy
    - labels.npy
    - coord.npy
    - points.npy
    - prob.npy
  outputs:
    - raw
    - labels
    - coord
    - points
    - prob
- id: workflow
  op: run_workflow
  inputs: [ "${{ test_tensors.outputs.raw }}" ]
  options:
    rdf_source: "${{ self.rdf_source }}"
  outputs:
    - labels
    - coord
    - points
    - prob
- op: assert_close
  inputs: ["${{ test_tensors.outputs.labels }}", "${{ workflow.outputs.labels }}"]
- op: assert_close
  inputs: ["${{ test_tensors.outputs.coord }}", "${{ workflow.outputs.coord }}"]
- op: assert_close
  inputs: ["${{ test_tensors.outputs.points }}", "${{ workflow.outputs.points }}"]
- op: assert_close
  inputs: ["${{ test_tensors.outputs.prob }}", "${{ workflow.outputs.prob }}"]
